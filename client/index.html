<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Patterns</title>
	<style>

/* Animations */
@keyframes show {
    from {
        transform:scale(0.7);
        opacity:0
    }
    to {
        transform: scale(1);
        opacity:1
    }
}
@keyframes hide {
    from {
        transform:scale(1);
        opacity:1
    }
    to {
        transform: scale(.7);
        opacity:0
    }
}
/*---*/
body { margin: 0; }

#countdown {
    position: absolute;
    width: 4em;
    padding: 5px 0;
    margin: 0 auto;
    top: 5px;
    right: 0;
    left: 0;
    background-color: #4C4C4C;
    text-align: center;
    color: #fff;
    border-radius: 15px;
    font-family: Arial, sans-serif;
    z-index: 255;
}

#points {
	position: absolute;
}

#board { 
	width: 100vmin; height: 100vmin; 
	display: flex;
	flex-direction: row;
	flex-wrap: wrap;
	align-content: center;
	justify-content: center;
}

.card {
	border: 2px solid rgba(0,0,0,0);
	box-shadow: 0 0 2px;
	margin: 5px;
	float: left;
	opacity: 0;
	transition: opacity .5s ease-in-out;
	animation: hide .5s;
	animation-fill-mode: both;
	position: relative;
	width: 20%;
}
.card:before {
	content: "";
	display: block;
	padding-top: 150%;
	}
.card.selected {
	border-color: black;
}
.card.vis {
	animation:show .5s;
    animation-fill-mode:both
}

.card > .content {
	display: flex;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
}

.symbol {
	border: 3px solid black;
	position: relative;
	margin: 5px;
	width: 30%;
}
.symbol:before {
	content: "";
	display: block;
	padding-top: 100%;
}
.symbol > .content {
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
}
.symbol.circle {
  border-radius: 100%;
}
.symbol.triangle {
  border-radius: 30%;
}
.symbol.lines.blue {
	background-color: rgba(0,0,255,.4);
}
.symbol.lines.red {
	background-color: rgba(255,0,0,.4);
}
.symbol.lines.green {
	background-color: rgba(0,128,0,.4);
}
.symbol.full.blue {
	background-color: rgba(0,0,255,1);
}
.symbol.full.red {
	background-color: rgba(255,0,0,1);
}
.symbol.full.green {
	background-color: rgba(0,128,0,1);
}
.symbol.green {
  border-color: green;
}
.symbol.blue {
  border-color: blue;
}
.symbol.red {
  border-color: red;
}



	</style>
</head>
<body>
	<div id="countdown" style="display: none"></div>
	<div id="points"></div>
	<div id="board" style="display:none">
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
	</div>

  	<!-- JS -->
  	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script>
		$(function () {
			var socket = io();
			var board;
			var ourTurn = false;
			var timer = null;

			socket.on('joined', function (json) {
				try {
					var data = JSON.parse(json);
					board = data.board;
					renderGame();
				} catch(e) {console.log(e); }
			});

			socket.on('solution_block_response', function (json) {
				try{
					var data = JSON.parse(json);
					if(data.success) { 
						startTurn(data.countdown);
					} else {
						endTurn('alreadyBlocked');
					}
				} catch(e) {}
			});

			socket.on('solution_response', function (json) {
				try {
					var data = JSON.parse(json);
					if(data.correct) {
						reason = 'correctSolution';
						//handle correct solution
						data.oldCardsCids.forEach(function (cid) {
							delete board[cid];
						});
						data.newCards.forEach(function (card) {
							board[card.cid] = card;
						});
						renderUpdate(data.oldCardsCids, data.newCards);

					} else {
						reason = 'badSolution';
						console.log(data.error);
						// do some more UI stuff to give the user some feedback
					}
					$('#points').html(data.points);
					endTurn(reason);
				} catch(e) {console.log(e); }
			});

			socket.on('solution_found', function (json) {
				try { 
					var data = JSON.parse(json);
					//handle correct solution
					data.oldCardsCids.forEach(function (cid) {
						delete board[cid];
					});
					data.newCards.forEach(function (card) {
						board[card.cid] = card;
					});
					renderUpdate(data.oldCardsCids, data.newCards);
					$('.card.selected').removeClass('selected');
				} catch(e) {console.log(e); }
			});

			function buildCard(card) {
				var cardContainerEl = $('<div class="card" id="' + card.cid + '"></div>'),
					cardContentEl = $('<div class="content"></div>');
				
				cardContainerEl.click(function (e) {
						if(!ourTurn) { askForTurn() }
						$(this).toggleClass('selected');
						checkAndSendSolution('.selected');
					});

				for (var i = card.count - 1; i >= 0; i--) {
					cardContentEl.append(buildSymbol(card));
				};
				return cardContainerEl.append(cardContentEl);
			}

			function buildSymbol(card) {
				return '<div class="symbol '+ card.color +' '+ card.shape +' '+ card.fill +'"><div class="content"></div></div>';
			}

			function renderGame() {
				var boardEl = $('#board');
				
				boardEl.empty();
				Object.keys(board).forEach(function (cid) {
					boardEl.append(buildCard(board[cid]));
				});
				boardEl.show();

				$('.card').addClass('vis');
			}

			function renderUpdate(oldCardsCids, newCards) {
				if(!oldCardsCids) {
					//only add new ones
				} else if(!newCards) {
					//only remove old ones
				} else if(oldCardsCids.length === newCards.length) {
					//update inplace
					oldCardsCids.forEach(function (cid, i) {
						var el = $('#' + cid);
						el.removeClass('vis');
						setTimeout(function () {
							el.attr('id', newCards[i].cid)
								.children('.content')
								.empty()
								.append(buildSymbol(newCards[i]));
							el.addClass('vis');
						}, 500);
							
					});
				}	
			}

			function startTurn(milisecondsToGo) {
				ourTurn = true
				// set timer
				var countEl = $('#countdown')
				timer = setInterval(function(){
					var oldValue = parseFloat(countEl.html());
					if(oldValue > 0.1) {
						countEl.html((oldValue - 0.1).toFixed(1));
					} else {
						endTurn('countdown');
					}
				}, 100);
				countEl.html(milisecondsToGo / 1000);
				countEl.show();
			}

			function endTurn(reason) {
				console.log('End of turn: ' + reason)
				clearInterval(timer);
				$('#countdown').hide();
				ourTurn = false;
				$('.card.selected').removeClass('selected');
			}

			function checkAndSendSolution(selector) {
				var selected = $(selector);
				if(selected.length === 3) {
					if(ourTurn) {
						console.log('3 cards selected -> send solution');
						sendSolution([selected[0].id, selected[1].id, selected[2].id]);
					} else { console.log('Can not send. It is not our turn!'); }
				}
			}

			function sendSolution(cids) {
				try {
					socket.emit('solution_query', JSON.stringify({
						cids: cids
					}));
				} catch(e) { console.log('Couldn\'t send solution'); }
			}

			function askForTurn() {
				try {
					socket.emit('solution_block');
				} catch(e) { console.log('Couldn\'t send request for solution block'); }
			}
		});
	</script>
</body>
</html>