<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Patterns</title>
	<style>

/* Animations */
@keyframes show {
    from {
        transform:scale(0.7);
        opacity:0
    }
    to {
        transform: scale(1);
        opacity:1
    }
}
@keyframes hide {
    from {
        transform:scale(1);
        opacity:1
    }
    to {
        transform: scale(.7);
        opacity:0
    }
}
.blendOut {
	opacity: 0;
	transition: opacity .5s ease-in-out;
	animation: hide .5s;
	animation-fill-mode: both;
}
.blendIn {
	animation:show .5s;
    animation-fill-mode:both
}
.invisvible {
	visibility: hidden;
}

/*---*/
body {
    width: 100vmin;
    height: 100vmin;
    margin: 0;
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    font-family: Arial, sans-serif;
}
label {
    margin-right: .4em;
}

#countdown {
	height: 2em;
	margin: 0 .5em;
}

#points {
}

#stats {
    font-size: small;
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 1.5em;
}
#board { 
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    align-content: flex-start;
    justify-content: center;
    flex-grow: 1;
}

.card {
    border: 2px solid rgba(0,0,0,0);
    box-shadow: 0 0 2px;
    margin: 1%;
    width: 17%;
    display: flex;
    flex-basis: 30%;

}
.card:before {
	content: "";
	display: block;
	padding-top: 150%;
	}
.card.selected {
	border-color: black;
}

.card > .content {
	display: flex;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
}

.symbol {
	border: 3px solid black;
	position: relative;
	margin: 5px;
	width: 30%;
}
.symbol:before {
	content: "";
	display: block;
	padding-top: 100%;
}
.symbol > .content {
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
}
.symbol.circle {
  border-radius: 100%;
}
.symbol.triangle {
  border-radius: 30%;
}
.symbol.lines.blue {
	background-color: rgba(0,0,255,.4);
}
.symbol.lines.red {
	background-color: rgba(255,0,0,.4);
}
.symbol.lines.green {
	background-color: rgba(0,128,0,.4);
}
.symbol.full.blue {
	background-color: rgba(0,0,255,1);
}
.symbol.full.red {
	background-color: rgba(255,0,0,1);
}
.symbol.full.green {
	background-color: rgba(0,128,0,1);
}
.symbol.green {
  border-color: green;
}
.symbol.blue {
  border-color: blue;
}
.symbol.red {
  border-color: red;
}



	</style>
</head>
<body>
	<div id="stats">
		<div id="countdown" class="invisvible"></div>
		<div><label>Points:</label><span id="points">0</span></div>
		<div><label>Failures:</label><span id="badAttempts">0</span></div>
		<div><label>Successes:</label><span id="goodAttempts">0</span></div>
		<div><label>Cards left:</label><span id="cardsLeft">0</span></div>
		<button id="moreCards">I need more</button>
	</div>
	<div id="board" class="invisvible">
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
		<div class="card"><div class="content"></div></div>
	</div>

  	<!-- JS -->
  	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script>
		$(function () {
			var socket = io();
			var board;
			var ourTurn = false;
			var timer = null;

			socket.on('joined', function (json) {
				try {
					var data = JSON.parse(json);
					board = data.board;
					renderGame();
				} catch(e) {console.log(e); }
			});

			socket.on('solution_block_response', function (json) {
				try{
					var data = JSON.parse(json);
					if(data.success) { 
						startTurn(data.countdown);
					} else {
						endTurn('alreadyBlocked');
					}
				} catch(e) {}
			});

			socket.on('more_cards_response', function (json) {
				try{
					var data = JSON.parse(json);
					if(data.success) { 
						console.log('We got more cards');
						data.newCards.forEach(function (card) {
							board[card.cid] = card;
						});
						renderBoardUpdate(null, data.newCards);
					} else {
						console.log('Board already full!');
					}
				} catch(e) {}
			});

			socket.on('solution_response', function (json) {
				try {
					var data = JSON.parse(json);
					if(data.correct) {
						reason = 'good solution';
						//handle correct solution
						data.oldCardsCids.forEach(function (cid) {
							delete board[cid];
						});
						data.newCards.forEach(function (card) {
							board[card.cid] = card;
						});
						renderBoardUpdate(data.oldCardsCids, data.newCards);

					} else {
						reason = 'bad solution';
						console.log(data.error);
						// do some more UI stuff to give the user some feedback
					}
					renderStatsUpdate(data.stats);
					endTurn(reason);
				} catch(e) {console.log(e); }
			});

			socket.on('solution_found', function (json) {
				try { 
					var data = JSON.parse(json);
					//handle correct solution
					data.oldCardsCids.forEach(function (cid) {
						delete board[cid];
					});
					data.newCards.forEach(function (card) {
						board[card.cid] = card;
					});
					renderBoardUpdate(data.oldCardsCids, data.newCards);
					$('.card.selected').removeClass('selected');
				} catch(e) {console.log(e); }
			});

			function buildCard(card) {
				var cardContainerEl = $('<div class="card blendOut" id="' + card.cid + '"></div>'),
					cardContentEl = $('<div class="content"></div>');
				
				cardContainerEl.click(function (e) {
						if(!ourTurn) { askForTurn() }
						$(this).toggleClass('selected');
						checkAndSendSolution('.selected');
					});

				for (var i = card.count - 1; i >= 0; i--) {
					cardContentEl.append(buildSymbol(card));
				};
				return cardContainerEl.append(cardContentEl);
			}

			function buildSymbol(card) {
				return '<div class="symbol '+ card.color +' '+ card.shape +' '+ card.fill +'"><div class="content"></div></div>';
			}

			function renderGame() {
				var boardEl = $('#board');
				
				boardEl.empty();
				Object.keys(board).forEach(function (cid) {
					boardEl.append(buildCard(board[cid]));
				});
				$('#board').removeClass('invisvible');
				$('.card').addClass('blendIn');
			}

			function renderBoardUpdate(oldCardsCids, newCards) {
				if(!oldCardsCids) {
					//only add new ones
					boardEl = $('#board');
					newCards.forEach(function(card) {
						board[card.cid] = card;
						boardEl.append(buildCard(card));
					});
					// $('.card').css('width', '20vmin')
					$('.card').addClass('blendIn');
				} else if(newCards.length === 0) {
					//only remove old ones
					oldCardsCids.forEach(function (cid, i) {
						var el = $('#' + cid);
						el.removeClass('blendIn')
							.addClass('blendOut')
							.remove();							
					});
					// $('.card').css('width', '25vmin')
				} else if(oldCardsCids.length === newCards.length) {
					//update inplace
					oldCardsCids.forEach(function (cid, i) {
						var el = $('#' + cid);
						el.removeClass('blendIn')
							.addClass('blendOut');
						setTimeout(function () {
							el.attr('id', newCards[i].cid)
								.children('.content')
								.empty()
								.append(buildSymbol(newCards[i]));
							el.addClass('blendIn');
						}, 500);
							
					});
				}
				// var colums = Object.keys(baord).length / 3
				// var newWidth = parseInt($('body').css('width'), 10) / columns
				// console.log(newWidth)
				// $('.card').css('width', newWidth)	
			}

			function renderStatsUpdate(stats) {
				$('#points').html(stats.points);
				$('#goodAttempts').html(stats.goodAttempts);
				$('#badAttempts').html(stats.badAttempts);
			}

			function startTurn(milisecondsToGo) {
				ourTurn = true
				// set timer
				var countEl = $('#countdown')
				timer = setInterval(function(){
					var oldValue = parseFloat(countEl.html());
					if(oldValue > 0.1) {
						countEl.html((oldValue - 0.1).toFixed(1));
					} else {
						endTurn('countdown');
					}
				}, 100);
				countEl.html(milisecondsToGo / 1000);
				countEl.removeClass('invisvible');
			}

			function endTurn(reason) {
				console.log('End of turn: ' + reason)
				clearInterval(timer);
				$('#countdown').addClass('invisvible');
				ourTurn = false;
				$('.card.selected').removeClass('selected');
			}

			function checkAndSendSolution(selector) {
				var selected = $(selector);
				if(selected.length === 3) {
					if(ourTurn) {
						console.log('3 cards selected -> send solution');
						sendSolution([selected[0].id, selected[1].id, selected[2].id]);
					} else { console.log('Can not send. It is not our turn!'); }
				}
			}

			function sendSolution(cids) {
				try {
					socket.emit('solution_query', JSON.stringify({
						cids: cids
					}));
				} catch(e) { console.log('Couldn\'t send solution'); }
			}

			function askForTurn() {
				try {
					socket.emit('solution_block');
				} catch(e) { console.log('Couldn\'t send request for solution block'); }
			}

			$('#moreCards').click(function() {
				try {
					socket.emit('more_cards');
				} catch(e) { console.log(s); }
			})
		});
	</script>
</body>
</html>